# Merged Consensus

## Background

本文是对 [Building Scalable Decentralized Payment Systems](https://arxiv.org/pdf/1904.06441) 的梳理，
目的是从理论上理清 Optimistic Rollup 的去中心化和安全性。这篇文章是 [Minimal Viable Merged Consensus](https://ethresear.ch/t/minimal-viable-merged-consensus/5617)（第一个 Optimistic Rollup 的可行性规范）
的理论基础。本文假设读者对 Optimistic Rollup 有一定基础性的了解，所以在文章组织上以目标-解释的方式进行组织，并没有
循序渐进的介绍一些细节背景，同时对于一些在工业界没有落地的描述也进行了省略。

## 基础知识

本部分主要是从理论上定义了 blockchain 的去中心化和安全性，因为这是 Optimistic Rollup 需要保证的，
因此需要进行说明。最后还介绍了当前 blockchain 扩展性的瓶颈为 Optimistic Rollup 的设计明确目标。

### 去中心化定义

**分布式的** ：blockchain 在多个节点之间进行复制。

**无权限的**：blockchain 可以被读取和写入，而无需现有系统参与者的许可——无需权限——即任何节点都可以成为出块节点。

**无信任的**：通俗的说无信任指的是，没有第三方参与——无需信任的外部资源帮助。

但是，这种描述并不严谨，仅仅可以用于帮助我们理解的一种通俗表达，因为第三方参与了也可以是无信任的，
判断的标准应该是第三方给的帮助是否破坏了 blockchain 的去中心化，没有的话破坏的话，即使有第三方
也可以是无信任的。

接下来，严谨的看一下无信任的定义，blockchain 的推进是在状态元素的基础上进行的，所以第三方的帮助核心
是看 blockchain 在推进的过程中是否有对状态元素的帮助，如果状态元素的读写或者更新必须依赖第三方，那肯
定是违背了去中心化的，因此需要对状态元素进行研究。理论上在 blockchain 中状态元素分为两种即拥有的，和
未拥有的，一个状态元素可能被 owner 拥有，也可能被 owner 委托给 delegator 拥有。

状态元素是活跃的：一个拥有的状态元素如果能够在有限时间内被其所有者（或在其权限范围内的委托所有者）修改，
则该状态元素是“活的”。如果一个未拥有的状态元素能够在有限时间内变为拥有，则该状态元素也是“活的”。

状态元素是安全的：一个拥有的状态元素如果不能被任何非所有者（或在权限范围外的委托所有者）修改，则该状态
元素是“安全的”。未拥有的状态元素是自然而然安全的。

* **无信任的**：blockchain 是无信任的，当且仅当他的状态元素即是获得又是安全的。


状态元素活跃的，表示一个状态元素在系统中可以被访问，不需要第三方提供帮助。 状态元素是安全的表示访问是需
要权限的，所以无信任的核心是所有的元素都可以在 blockchain 系统内部根据权限进行访问。

**去中心化的**： blockchain 是分布式的，无权限的，无信任的。

### 安全性定义

**安全性**： blockchain 的安全性来自修改历史的成本。

所以这俩面有女巫攻击（51%攻击）的问题，共识协议正式解决这个问题（PoW，PoS等），所以 blockchain 的安
全性来自于共识协议。

纯粹的基于权益的共识协议并不符合无权限的定义，因为： 
1. 没有已知的公平初始分配权益的方式。
2. 参与系统需要从系统参与者那里购买硬币或代币。

这两个问题通过中本共识的工作量证明（PoW）得以解决。

### 扩展性问题

扩展瓶颈的根本原因在于，去中心化区块链网络中的每个区块必须由网络上的每个节点（客户端）进行完全验证。通过
牺牲安全性或去中心化，可以轻松提高交易吞吐量，因此真正的挑战在于设计一个可扩展、安全且去中心化的系统。

几乎所有的扩展提案都旨在不让每个节点验证每个区块，而是让一部分节点验证一部分（在某种程度上相关的）交易。
Layer-1扩展提案旨在提高基础链的交易吞吐量，通常采用分片技术，将交易和状态分割成各个分片，而不是将它们全
部收集到一个逻辑链中。在这种模型中，交易吞吐量与分片数量成正比（减去管理分片的开销）。需要注意的是，基于
PoW的分片是不受欢迎的，因为安全性会在分片之间分散。

## Optimistic Rollup
### 设计方案
一个合约被部署到父链上，用于跟踪侧链区块头、存款和提款，并处理欺诈证明。通过完全在链上运行的领导者选择协议
（下一节介绍），领导者可以向合约提交一个侧链区块，并附带一个可参数化大小的质押。该区块必须扩展合约已知的侧
链顶端，否则将立即被拒绝。侧链区块的内容在交易的数据字段中完整发布，例如以太坊的 calldata 。合约将对侧链
的交易进行身份验证（即进行 Merklelization ），并将其与发布的交易根进行比较，或计算实际的区块头哈希。最后，
区块头哈希由合约保存以备后用——本质上，该合约运行着一个侧链的轻客户端。

经过可参数化的最终确认延迟，未受到挑战的侧链区块可以被最终确认（即变得不可逆）。如果一个未最终确认的侧链区
块包含无效的状态转换，任何人都可以在链上提交欺诈证明，如果证明有效，则将侧链的顶端回滚到前一个区块，并将孤
儿侧链区块的一半质押奖励给证明者（另一半则有效或明确地被销毁）。

侧链区块生产者被激励全面验证链，否则他们扩展无效区块的质押将被销毁。

在这个系统中，存款非常简单：用户只需将资金发送到合约，然后立即在侧链上花费它们。提款可以通过在侧链上先销毁
资金，然后在链上发布一个非交互式提款请求，并**提供对此销毁的最终侧链区块的包含证明来完成**。

## 合并共识
共识协议的基本组成包括一下四个部分：
1. 分叉选择规则：如何在两个有效链之间进行选择。 
2. 区块有效性函数：完全定义状态转换。 
3. 领导者选择算法：确定谁可以通过用新块扩展顶端来推进链（一些去中心化共识协议是无领导者的）。 
4. Sybil抵抗机制：如工作量证明（Proof-of-Work）或权益证明（Proof-of-Stake）。

**提交链**： 是一种侧链，通过定期提交区块哈希（即将侧链区块哈希作为状态转换包含到母链中）来借用父链的安全性。

Optimistic Rollup 是无分叉的，本文推荐的状态模型是 UTXO，即状态转换函数，Sybil抵抗机制借用了父链的安全性。

## 安全性分析
所提议的侧链方案提供的双向挂钩是信任最小化的。我们假设攻击者的能力弱于父链上大多数区块生产者的审查攻击。
首先，信任最小化的意思是在双向通信的时候参与放最少，即只有 L1 和 L2 两个需要的通信实体，无需信任第三方
（注意：relayer 不属于第三方，安全委员会属于）。其次，攻击者很难在父链层面做到女巫攻击，自然不会控制 L2，
想要控制 L2 需要成为 L2 的生成者并且能够控制 L1（即 51% 攻击）才能够真正的控制 L2，在安全模型分析中，
这被认为是不可能的。

**为什么挑战期是 7 天？ 本质上是因为连续 7 天控制 L1 或者说对 L1 发起了连续 7 天的女巫攻击成本是极高的，
极高到认为是不可能的。**

## 总结
L2 的去中心化单独看是做不到的，目前 Optimistic Rollup 的出块节点还不是分布式的，更不是无权限的，基本是
运营商负责出块。但是，L1 和 L2 作为整体，L2 作为 L1 执行层的扩展来看，L1 的安全性和去中心化并没有因为 L2
的引入发生变化，或者说 L2 上面的交易完全复用了 L1 的去中心化和安全性。