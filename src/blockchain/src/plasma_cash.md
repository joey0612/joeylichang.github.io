# Plasma Cash

## 目的

Plasma 是一种侧链的解决方案，因为他有独立的共识机制，单独的安全性和去中心化程度。与现在大行其道的 Rollup 不同，后者完全复用 Layer1 的安全性和去中心化程度。 但是这里还花费时间介绍其框架以及两个最早/最基本的实现，主要是这里很多的设计被 Rollup 借鉴（2017年和2019年分别被 V 神提出来），所以窥探 Plasma 并与 Rollup 对比，可以更好的理解 Layer 2。

我的理解，Rollup 与 Plasma 在框架协议的设计上有一点不同，直接决定了其根本的不同的，也就引申出了一系列 Rollup 的收益。

**不同点在于：Rollup 需要提交 Layer2 区块数据到 Layer1，这就使得 Layer1 本身对 Layer 2 具备验证能力。**

引申出来的收益：
1. 安全性和去中心化程度完全复用了 Layer1，否则欺诈证明的验证需要依赖 Layer2 节点，只有 MPT 的 Root 或者说轻节点是验证不了真伪的，需要 Layer2 协助。
2. Layer2 层去掉了最少诚实节点数量的限制，即有一个诚实节点发起挑战即可，不需要多数节点诚实，除非攻击者掌握了多数的 Layer1 出块节点（这个攻击模型被认为是不可持续的，因为成本很高——比如7天——不可持续的就不会造成不可逆的欺诈）。

总结一下 Plasma 框架的核心（其实也是 Rollup 的核心步骤）：
1. 存款（需要 Layer1 合约支持）
2. 交易确认（提交状态到 Layer1）
3. 取款（简单，快速，批量）
4. 欺诈证明

Plasma 发展的历史简单梳理一下：
1. Plasma白皮书，201708
2. Plasma MVP，201801
3. Plasma Cash，201803
4. Plasma XT，201805
 
   是一种使用密码经济聚合签名和检查点技术的方案，它可以减少存储需求并保持最终结果。成功的检查点允许用户在检查点之前丢弃既往历史记录，从用户的角度，它显著减少了存储需求，因为检查点是被视为最终的，并且之前的交易无法被逆转或质疑。

5. Plasma Debit && Plasma MoreVP，201806

   Plasma Debit 允许可分割的金额交换（Plasma Cash的一个特性是，它无法被切割或合并）。每一个Plasma Debit币，在当前币的所有者与操作者之间，基本上相当于一个双向支付通道（类似闪电网络的多重签名支付通道）。这允许操作者在任意数量的支付通道中记录微额交易。


## Plasma

### 背景
**首先**，Plasma 产生的背景就是解决以太坊的扩展性，解决扩展性问题无外乎就是 Layer1 或者 Layer2 扩容，Layer1 扩容也称作链上扩容（Sharding），Layer2 扩容也称作链下扩容，Plasma 属于 Layer2 扩容，最早于 2017 年 8 月 被 Joseph Poon(闪电网络创始人)和 V 神提出来。二层扩容的核心思想：
1. 将计算转移到链下。
2. 将底层区块链作为共识基础。
3. 使用智能合约或者其它手段作为链下和链上沟通的桥梁。
4. 当有欺诈行为发生时链下的用户仍然可以回到链上的某一状态。

虽然将计算转移到链下会在一段时间内损失最终性，但这个代价是值得的，因为这样做不止可以极大提高区块链的灵活性和可扩展性，也极大降低了用户进行交易所需要的代价。将计算转移到链下也并不意味着完全放弃安全性，因为最终的安全性还是由底层所依赖的区块链来保证，因此二层扩容主要关注的问题就在于如何保证链上链下切换过程的安全性。

**其次**，Plasma 是框架，是设计的标准（即需要满足这个标准才能是安全的），所以他不是具体实现，具体实现会因项目不通有所区别。本文主要就是介绍这个框架的一些核心点（或者叫做关键步骤），并介绍两种被广泛讨论的案例。

**最后**，粗略地介绍一下 Plasma 框架的大体，目的是要明确：
* **Plasma 所要做的工作并不是保护子链的安全，而是当有安全事故发生时，保证用户可以安全地取回自己的资产，并返回到主链上。并且采用一系列经济激励的方式减少作恶情况的发生。**
  
Plasma 框架主要内容：
1. 运营商创建一系列智能合约作为主链和子链通信的媒介。
2. 智能合约
   1. 规定了子链中的一些基本的状态转换规则（例如如何惩罚作恶的节点）。
   2. 记录了子链中的状态（子链中区块的哈希值）。
3. 运营商搭建子链，可以拥有专门的矿工，使用不同于主链的共识算法等，完全独立的子链。
4. 用户需要在主链上购买数字资产后转移到子链上
   1. 注意：用户的资产必须在主链上买，保证子链作恶的情况下可以立刻拿回来。
5. 之后用户就可以完全脱离主链，在子链上进行交易。
6. 运营商扮演 operator 的角色
   1. 打包区块。
   2. 在需要时由 operator 将区块的哈希值提交到主链作为子链的状态更新证明。
   3. 在这个过程中，用户完全不需要和主链交互。
7. 用户或者其他任何阶段（子链是去权限的）可以校验子链的数据，如果发现作恶，可以向主链发送
   Fraud Proof，如果被主链确认，用户可以拿到自己的抵押并得到奖励（奖励来自罚没的运营商资产）。

### Plasma 框架关键步骤

#### 存款(Deposit)
用户在将主链的资产转移到 Plasma Chain 的过程称为存款(Deposit)。
1. 向主链上的 Plasma 合约发送以太币或 token。
2. Plasma 合约收到 Deposit 交易后会在子链上创建跟 Deposit 数额一致的交易。
3. 将其打包进 Layer2 区块中，作为存款确认的证明。

当用户看到子链上自己之前存款的交易被确认后，就可以在子链上使用这笔资产（给子链上的其他用户发送交易或者退出子链等）。


#### 状态确认(State Commitment)

当大部分都转移到链下进行时，需要某种机制确保链下状态的更新得到确认，这样才能保证当有恶意行为发生时，主链可以保证用户不会受到损失。所以需要，子链周期性地将状态更新情况提交到主链进行共识。

然而，将子链中的所有交易都同步到主链显然违反了 Plasma 的初衷，在 Plasma 中，实际向主链提交的是 Merkle Tree 的根哈希。因此子链中的实际交易情况被隐藏，在主链上只能看到子链区块的哈希值。

__注意: 这里没有向 RollUp 一样将区块数据作为 calldata 上链，那就需要 L2 可以防止女巫攻击，并且校验欺诈证明的时候需要更多资源。__

当有恶意行为发生时，子链网络中的所有用户都可以向主链提交防伪证明，证明成立后，含有恶意交易的区块将被回滚。

#### 防伪证明(Fraud Proof)

防伪证明的意义在于只要发布区块的节点构造了含有恶意交易的区块，那么就要承担被惩罚的风险。每当新的区块被提交到主链上时，会留出一段时间给用户提交防伪证明，如果在这段时间内没有证明被提交，则认为新的区块被验证合法。如果有防伪证明检测到区块中存在恶意交易，则该区块将被舍弃，回滚到上一个被验证合法的区块。主要包括一下几种：

1. 资产可花费证明
2. 交易签名有效性证明 
3. 存取款证明

#### 取款(Withdrawal)

前提：**当子链中有取款操作发生时，跟这个取款操作相关的账号或者交易都将被禁止。**

##### 简单取款
执行简单取款的条件是所要取回的资产已经在主链和子链上确认，即向子链提交了取款交易，并被打包进区块。
1. 向主链上的 Plasma 智能合约发送已签名的取款交易。
   * 取款的数额可以包含多个输出（UTXO模型），但所有输出必须在同一个子链当中，而且每个输出的余额必须全部取出，不能只取出一部分。取款数额的一部分还需要被当作押金，作为恶意行为的惩罚。
2. 当取款请求发送后，需要等待一段“争议期(Challenge Period)”。
   * 这期间其它节点可以构造证据证明该取款中的部分或全部数额已经被花费。如果争议期内有节点提供证明成功，那么取款被取消，而且押金被扣除。
3. “先来后到”的顺序执行。
   * 接下来可能还要等待一段时间，直到所有区块高度较低的取款操作都完成。
   * 这里主要是防止有恶意交易（双花），保证恶意交易之前的交易可以正确执行。——（后面会详细介绍）。
4. 当争议期结束后，如果没有争议被提出，则认为取款操作成立，取款者将子链资产成功取回到主链。

##### 快速取款
快速取款跟简单取款相比的差别主要是引入一个中间人，白皮书上称为 Liquidity Provider。如果一个用户不想等待很长的争议期，那么可以选择从 LP 这里直接取款，只需要消耗一个交易确认的时间，代价是需要支付给 LP 一定的费用。

1. Alice 首先向流动合约(子链)发送 10 以太币。
2. 当这个交易被子链打包成区块后，Alice 可以调用合约中的某个退出函数，这时 Alice 将获取一个代表她这笔资产的 token(类似一个证明)。
3. Bob 作为 LP，他检查了子链上数据之后证明 Alice 的取款没有问题之后愿意以 9 以太币的价格购买这个 token(拥有这个证明可以提款在流动性合约中)。
4. Alice 将 token 卖给 Bob，获得了 9 以太币（主链），Bob 赚取了 1 以太币。

需要注意的是，实现快速取款的前提条件是没有拜占庭行为发生，即没有扣留区块攻击发生，因为 LP 需要验证取款方的交易历史。

1. 扣留攻击：子链上的矿工恶意扣留区块，意图双花攻击等，多余 2/3 的正直节点即可避免。
2. 交易历史验证，可以保证 Alice 没有欺骗 LP（这个后面会详细介绍），如果有扣留攻击交易历史必然被篡改。

##### 批量取款

当子链中有拜占庭行为（例如，区块扣留攻击）发生时，将会影响以后生成防伪证明，因此网络中的每个用户都有责任快速退出子链。批量取款正式子链发生攻击的时候，用户进行资产不被侵占的有效手段。

批量取款操作由于所采用的模型(UTXO 模型或者账户模型)不同会有较大的差别，而且目前关于批量取款的操作细节也正在研讨当中，再此不过多介绍了。


## Plasma MVP(Minimal Viable Plasma)

Plasma MVP 是 V 神和他的团队在 2018 年 1 月初提出的基于 UTXO 模型实现的 Plasma 设计标准，它以最简单的方式实现了链下交易，但无法支持复杂的计算，例如脚本（Script）和智能合约。

Plasma MVP 是 Plasma 框架第一个可行的实施方案，与 Plasma 框架本身的重点区别如下：
1. 基于 UTXO，这个在取款中特别重要。
2. Operator 是单一一个，采用 PoA（Proof of Authority），这个也给安全性带来了一些需要讨论的点。
3. 存款之后 Layer1 上的合约会保证这个交易作为一个区块中的唯一交易并插入到 L2 上，注意这个区块没有其他的交易。
4. 取款过程中，旧的 UTXO 总能先执行，并且需要用户二次签名才能取出（即，确认签名）——这个是 Plasma MVP 的核心。

在 Plasma MVP 中，用户的退出顺序以所要退出的 UTXO 所在的交易的位置为准。假如 operator 作恶，在一个合法的交易之前插入一个非法的交易，那么当用户执行取款时，由于非法交易可以先被取出，因此当执行到该用户的交易时，可能 Plasma 合约中的资产已经被取空。为了解决这个问题，Plasma MVP 采用了“确认签名”机制，例如当 Alice 产生一个交易时，她首先会对交易签名。当该交易被打包入区块后，Alice还需要对该交易进行一次签名，即“确认签名”。


引入确认签名机制后，当 Alice 发现在一个区块中自己的合法交易之前存在非法交易时，可以拒绝对自己的交易进行“确认签名”，同时申请取款。这样可以使得当前的交易失效，保证自己之前“确认签名”后的交易可以优先于非法交易之前取出。

**这种确认签名机制极大地破坏了用户体验，用户每产生一个交易都要经历签名->等待确认->确认签名。**

### 安全性
1. 用户用旧的 UTXO 提出更多的 token。
   
   收到用户转账的节点有动力发布欺诈证明获取恶意提款的罚金。   

2. Operator 提出恶意交易，取其他用户的token，或者铸造token给自己。
   
   争议期内用户会可以提出取款，因为其 UTXO 一定在这个欺诈的 UTXO 之前。

### Plasma MoreVP

为了解决多次签名的不好体验，社区提出 [Plasma MoreVP](https://ethresear.ch/t/more-viable-plasma/2160)。
简单概括有两点：
1. 更改的推出交易的优先级（旧的输出 UTXO 优先，改成年轻的输入 UTXO 优先）。
2. 两阶段挑战，避免了两次签名。

UTXO 优先机的改变，确保有效的 UTXO 在退出时能够优先被处理，无论其交易是否被包含在在后续的隐瞒区
块中，只要它们来源于有效的输入，就可以被处理，提升了体验。

第一阶段：退出阶段
1. 发布退出请求： 用户提交退出请求，声明他们希望退出的输出，并在请求中附上押金。此时可以是任何用户，不一定是该交易的参与者。
2. 附带用户退出： 诚实的输入或输出的所有者可以“附带”此退出，发布他们的押金。如果没有附带的用户，他们将无法退出。
3. 提交竞争交易： 任何用户可以提交与初始交易竞争的交易。提交竞争交易的用户必须放置押金。
4. 索赔和新押金： 任何其他用户可提出更早的竞争交易，索取相关的押金，并放置新的押金。这确保了最后提交的竞争交易也是最早的竞争交易，——用有效的 UTXO 替换无效的 UTXO，拿走押金，置换新的押金。
5. 退出处理： 如果没有曝光与退出的竞争交易，输出可以通过包含的支出进行挑战。任何未被挑战的输出将被退出，与之相关的押金将退还。

第二阶段：确认阶段
1. 确认交易有效性： 如果有竞争交易被提交，第二阶段的目的是确定所提出的交易是否是规范的。任何用户可以提交：
   1. 在第一阶段提交的所有竞争交易之前包含的原始交易；
   2. 任何附带的输入或输出（不包括初始交易本身）；
   3. 支出的合法性挑战，证明某个输入不是由规范交易创建。
2. 挑战与处理： 挑战（例如，类型 (2.) 和类型 (3.) 的挑战）将阻止该交易及其相关输入或输出的退出。如果挑战成功，仅正确可退出的交易会继续留在队列中。
3. 最终确认：在游戏结束时，只有正确可退出的交易将被处理，其余的将被移除。

这种两阶段流程确保了 Plasma MoreVP 在处理退出时的安全性和有效性，同时允许多个用户在退出过程中参与，有效防止了欺诈行为和重复支出。

## Plasma Cash

2018 年 3 月，在巴黎举行的以太坊开发者大会上，V 神发布了 Plasma Cash 模型，可以视为对 Plasma MVP 的改进。Plasma Cash 与 Plasma MVP 的主要区别是每次存款操作都会产生一个唯一的 coin ID 对应转移到侧链上的资产，并使用一种称为稀疏梅克尔树（Sparse Merkle Tree）的数据结构存储交易历史。由此带来的好处是用户不需要关注子链上的每个动态，只需要关注跟自己的 token 有关的动态。

Plasma Cash 中转入的资产(token)可以看作是 NFT，即一次转入的资产是唯一的（例如转 2 次 5 ETH，相当于两个不同的资产，NFT）。每个用户只需要关注他拥有的 NFT 即可，即他的交易历史（保证正确性或者说防止攻击）。

为了防止双花，每次交易需要提供这个 token 的历史交易，即从产生在当前经历的所有区块的交易历史，不仅包括交易的还需要包括未交易的（未交易的才会防止双花，否则无法证明这个证明链条是正确的）。这个数据量是很大的，在这里使用的 SMT（稀疏默克尔树） ，SMT的好处是很容易提供不存在证明。

具体的数据模型是，每一个 block 有一个 SMT，SMT 叶子节点就是 NTF ID（按顺序排列的叶子节点），如果这个 NTF 在当前区块内交易了，就有一条记录在叶子节点上，否则没有。在一个block上获取到一个token 是否被交易了就很容易了。

一个用户只需要关注自己的 token ，也就是自己持有的 token id 的所有交易历史，简单理解就是一个随和区块的增减 SMT 变多（理论上一个 block 一个 SMT），但是每个 SMT 只有若干个我关注的叶子节点即可。数据量自然也就没那么大。

### 提款

需要提交，最近两次交易证明，避免过长，安全性由欺诈证明保证。

### 安全性
1. 已花费证明
   
   A 转 token 给 B，然后 A 拿着旧的证明提款，B 有动力发起欺诈证明。   

2. 双花证明

   A 转 token 给 B 和 C 用同一个 token id，B 或者 C 有动力发起欺诈证明。

3. 非法交易历史证明

   operator 伪造 A 转 B ，然后 B 转 C， C 转 D， 这样 D 那最近两次的证明即可提款。
   但是 A 有动力要求提供 A 转 B 的证明，当然这种要求需要押金，防止 A 作恶，随意发起要求。

### 优点

1. 客户端 sharding，客户端只需监视 Plasma 链上的他们的代币。这意味着交易吞吐量可以在不增加个别用户负担的情况下进行扩展。
2. 交易不再需要两阶段发送加确认，一旦交易被包含在主链上，就可以进行支出。（验证交易历史）
3. 添加任何数量的独特代币（包括非同质化资产）没有额外的复杂性。
4. 大金额的退出安全性更高，因为窃贼必须为他们想要窃取的每个代币提交单独的退出交易（多个 token 组成一个大金额）。这意味着即使在发生盗窃的情况下，代币仍然是安全的，因为攻击者无法一次性取走所有代币。如果链条发生故障，虽然代币仍然安全，但服务会中断，用户无法进行正常的交易。

### 缺点

1. 由于每个代币必须分配一个序列号，因此无法铸造任意小的代币，否则在某个时点，赎回代币的燃气费用将超过代币本身的价值。
2. operator 中心化。

针对 operator 的去中心化，[PoS Plasma Cash with Sharded Validation](https://ethresear.ch/t/pos-plasma-cash-with-sharded-validation/1486) 提出来一个方案，核心思想：
1. 有一组出块节点 和 一组验证节点 都需要质押代币在主链上防止其作恶。
2. 出块节点采用 PoS 轮流出块，出块可以很大。
3. 验证节点根据策略或者规则验证大的默克尔树的一部份，并使用 BLS 签名（200，000 gas）占用的空间更小。

## Reference
[以太坊扩容技术-Plasma](https://wiki.learnblockchain.cn/ethereum/layer-2.html)
[PoS Plasma Cash with Sharded Validation](https://ethresear.ch/t/pos-plasma-cash-with-sharded-validation/1486)