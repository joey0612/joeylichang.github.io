# 闪电网络

## Key Points 
1. 闪电网络针对 **BTC 的 UTXO 模型**设计的 **Layer2** 扩容方案。
   1. 不依赖第三方。
   2. 可信交易对手。
2. 交易的双方建立通道，然后双方在链下进行任意次数的交易，以最终交易状态关闭通道。
   1. 通道是一个逻辑上的概念，实际使用过程中并没有“通道”，“通道”的术语用来表示链下交易双方的关系，
   2. 建立通道，也就这个关系上链了，告诉chain有两方在链下要进行交易，会有相应的技术（RSMC）保证这个通道的交易安全性。
   3. 关闭通道，双方在链下进行了任意多次交易之后，最终双方的状态被提交到链上，即关闭了双方的通道。
3. 闪电网络最重要的两项基础技术是 RSMC 和 HTLC。
   1. RSMC(可恢复序列到期合约)
      1. 支持双向支付。
      2. 一方中途退出，另一方可立即取回资金，而无需经过等待期，同时，对主动退出方实行惩罚。
      3. 通过可撤销合约，使交易的任一方都不可抵赖反悔（广播旧的交易）。
   2. HTLC(Hash Timelock Contract)
      1. HTLC技术将各个通道串联起来，成为**闪电网络**。
      2. 使得没有建立通道的双方可以通过第三方完成交易（第三方与双方建立了通道）。

## RSMC

### 5 中交易类型
1. 存款（fund）：建立通道之初通过“存款”交易将双方的资金存入双签名钱包，将存款交易广播到比特币网络就意味着双方建立了支付通道。但是在广播钱需要先签署一份“提交（commit）”交易，保证对手方消失的情况下仍然能取回双签名钱包中的资金。
2. 提交（commit）：支付通道建立后，交易双方在通道内进行资金往来时通过“提交”交易来实现。该交易的特征是一式两份，每一方都会签署好交易信息递交给对手方。参与者如果想终止支付通道可以将对方署过名的合约签字并广播到区块链，进行资金分配并关闭支付通道。
3. 分配（delivery）：“分配”交易是具体执行资金派送的交易，该交易执行完成后资金将抵达目标账户。通常指的是不可撤销的分配。
4. 违约补偿（breach remedy）:RSMC中核心的防抵赖机制，当对手方企图通过发布历史交易而抵赖后续交易是，可以通过发布“违约补偿”交易罚没对手方的所有资金。
5. 可撤销的分配（revocable delivery）：同样是资金派送的交易，但该交易的执行可能因为其他交易的执行而被撤回，在RSMC中主要会因为“违约补偿”交易的执行而被撤回。

fund 双方存款到双签地址，保证了双向支付，同时如果违约会进行罚没保证了不可抵赖。
commit 指的是链下普通的交易，但是由于是双签（2/2，即 2个签名都有效，交易才生效），所以交易一般是两个，双方个产生一个并互相交换进行签名，这里面个字生成的交易是是交易的 
**RSMC 的核心** 输出一般有两个出了正常的转账之外，还会带有一个惩罚输出，即提交旧的历史会进行惩罚。
可撤销的分配（revocable delivery）就是在调整期（n 个块高之内）如果对手提出了违约的证明，那么会撤销之前的分配交易并进行罚没。

### 流程

A 和 B 有多个私钥（R），除了在 fund tx 中用的不变（RF），之后每轮交易这个私钥都会交换给对方表示作废。
1. 建立通道 
   1. fund : A 和 B 提交 100 个 BTC 到公共的多签名地址（DA），但是都不会进行签名，输出是多签地址。
   2. commit： 
      1. A 生成的交易，B 持有，：
         1. 输入：A 用 A-R1 签名，等待 B 用 B-R1 签名。
         2. 输出1: 如果是 B 的 RF，**等待 100 个 block**， 100 BTC -> B , 如果是 B-R1 + A-RF, 100 BTC -> A
         3. 输出2: 100 BTC -> A
      2. B 生成的交易，A 持有：
         1. 输入：B 用 B-R1 签名，等待 A 用 A-R1 签名。
         2. 输出1: 如果是 A 的 RF，**等待 100 个 block**，100 BTC -> A , 如果是 A-R1 + B-RF, 100 BTC -> B
         3. 输出2: 100 BTC -> B
   3. A 和 B 交换 commit tx 并签名，并互相持有。
   4. fund tx 双方签名，之后上链，表示通道建立。
 
总结：commit tx 必须双方签名并互换的情况下才可以签名 fund tx 并上链，主要的原因就是 commit tx 的输出包含了惩罚措施。
我们以 A commit tx 为例，在下一轮交易之后（生成新的 commit tx） R1 会互换，如果 B 由作弊，A 可以拿着 B-R1 + A-RF
获取 B 的 100 个 BTC，对 B 进行惩罚。

2. 交易
   1. commit：A 转给 B 50 BTC 为例(以 A 的视角)，B 生成的交易，A 持有：
      1. 输入：B 用 B-R2 签名，等待 A 用 A-R2 签名。
      2. 输出1：如果是 A 的 RF，**等待 100 个 block**，50 BTC -> A , 如果是 A-R2 + B-RF, 50 BTC -> B
      3. 输出2: 150 BTC -> B
   2. 双方的新一轮的 commit 完成后，会互换 A-R1 和 B-R1

总结：如果 A 广播了上一轮的旧消息（对A有利，没有付 BTC买到了服务），同样下一轮完成之后会交换 R2，如果有抵赖被B在100 个 block 之内发现，会用 A 的 R2 发起违约补偿。
   

3. 关闭通道 
   1. 任何一方都可以拿着最新的状态提交上链（用 RF 签名），提出这个交易的一方会在 100 个 block 之后拿到 BTC。
   这个交易上链表示通道关闭。

4. 违约补偿 
   1. 如上述 fund 和 commit tx 介绍的输出，以及每轮结束会交换上轮交易的私钥，递归的保证了任何抵赖一方都会收到罚没。

## HTLC

尽管RSMC完善了通道的功能，但如果涉及多个用户，每个用户间开启通道则需要大量的时间与经济，HTLC技术将各个通道串联起来，解决这个问题。

A 与 B 由通道， B 与 C 有通道，A 与 C 没有通道。

1. A 通知 C，转账 100 BTC，同时收到随机数 R。
2. C 进行 Hash(R) 返回给 A。
3. A 通知 B，收到 R 其 hash 值等于 Hash(R)，则转账给他 100 BTC。
4. B 收到 C 的 R 值，并验证通过，取走 50 BTC 从 B。
5. B 用 R 值从 A 和 B 的 found tx 中取走 50 BTC。

注意： A 和 B 的退回交易是是带有超时的，即制定块高。

## 缺点
最大的问题是需要双方实时在线。


## Reference
1. [闪电网络](https://www.jianshu.com/p/e326802294e1)
2. [闪电网络RSMC协议技术原理](https://blog.csdn.net/zr1213159840/article/details/111320296)