# PBFT

## Overview

[PBFT](https://css.csail.mit.edu/6.824/2014/papers/castro-practicalbft.pdf) 是 [Leslie Lamport](https://en.wikipedia.org/wiki/Leslie_Lamport) 三篇经典的分布式共识协议的论文之一，其中 Paxso 解决的是可靠节点的共识，BFT 描述的是开放式分布式系统（可以有恶心节点）共识的模型和理论（拜占庭将军问题），PBFT 解决的是开放式分布式系统（可以有恶意节点）的共识协议。

区块链的 perssionless 特性使其为开放式分布式系统，所以 PBFT 被区块链技术关注。有一些基于 PBFT 实现共识的链，后面还衍生出 Tendermint BFT 等。社区最新的 HotStuff 写列共识协议也是类 BFT 共识。所以对于 PBFT 的深入理解和研究是有价值的并且可以助力其他共识协议的理解。

## PBFT Flow
![pbft](../../images/pbft.png)

1. Pre-Prepare
   1. leader 接受消息(proposal)，然后发送“就位”消息，包括[view，index，message，sign]，
   给其他的验证者。
2. Prepare
   1. 验证者收到预备消息之后，决定是否接受。
   2. 接受的话，广播签名的“预备”消息给所有的其他验证者，否则不发送任何消息。
   3. 当验证者收到 2/3 的“预备”消息，进入 Prepared 状态
      1. 收集的“预备”消息，成为“已预备证明”（Prepared-QC）
3. Commit
   1. Prepared 验证者决定是否要执行消息
   2. 执行的话，广播签名的“执行”消息，否则不发送任何消息，进入执行阶段
   3. 当验证者收到 2/3 的“执行”消息，执行消息，进入已执行状态

### Checkpoint

一般情况下，每个结点需要保存所有的历史数据和状态机的每个历史状态，以便在需要的时候可以复查。
但随着系统运行的时间越来越长，数据就会越来越多，最终肯定有存不下的情况。所以我们需要一种机制，
可以放心的丢弃以前的历史数据，又不致于影响系统的运行和结点间的信任。

检查点肯定是需要所有验证者达成共识，否则每个节点的检查点不一致，在换主的过程中会有数据的丢失。
检查点的创建可以不用三阶段，任何一个验证者需要创建的时候只需要发出消息并收集 2/3 的赞成签名。
创建消息需要包含位置，hash 等信息，收集的赞成签名消息会成为稳定检查点证明（这个在切主的时候会用到）。
证明一个 checkpoint 获得了 2/3 的认可，在选注的时候会作为条件之一。

检查点的推进可以是区间方式的，新的检查点大于前一个证明过的稳定检查点即可。

### View Change

1. 收到“预备”消息，到执行完会设置一个定时器，超时的话所有验证节点会发起签名的“变换”消息。
2. 先收到 2/3 赞成“变换”消息的验证者会成为新的 leader。
3. 新的 leader 会发送“新域”消息，消息带有自己的“已预备证明”。
4. 其他节点执行“已预备证明”的 Prepared 消息。

详细分析见[Partial Synchronization PBFT](./partially_synchronization.md#pbft)

注意：
1. 验证者投票一定有一些规则，比如选择检查点/ index 最大的，等（类似 Paxos 等）这里简略了。
2. **超时机制正式 PBFT 保证活性的基础，这样状态机才会在异常情况下推进，不会卡住。**

## Safety && Liveness

PBFT 的安全性主要来自两个点：
1. 拜占庭问题的结论，2/3 以上的诚实节点。
2. 三阶段，做到了对于需要执行的消息先达成共识，再保证执行达成共识的消息，防止因切主造成消息混乱（后续详细介绍）。

PBFT的活性，其实就是在超时情况下的切主，这是对 [FLP](./flp.md) 原理中异步系统假设的违背保证了其活性。

## Analysis

PBFT 的核心内容：三阶段，安全的基础是拜占庭容错（BFT,3f+1），三阶段的总超时切主保证其活性。
因为不涉及到实现的细节，原理性核心内容并不是很多，但是需要深入理解的点确实不少，因为它是后续很多协议的基础。有必要花费一些篇幅去深入理解，方便再次基础之上理解其它的共识协议。

下面会重点介绍如下几个点：
1. 三阶段中每个阶段到底做了什么，每个阶段目标是什么？
2. 为什么一定要三阶段，而不是两阶段？
3. PBFT 和区块链的共识到底有什么关系？对区块链的共识有什么启迪？


#### 三阶段做了什么，每个阶段目标是什么？

Pre-prepare 阶段广播 proposal 给所有的验证者，这里**广播**的内容其实是重点，proposal 带有执行的新消息位置（在实现过程中一般会带有前一个消息的证明），目的就是确认新消息在全网中执行的位置，保证全网状态机的执行顺序。

Prepare 阶段收到 proposal 之后进行校验，如果接受则**广播**对 proposal 的投票（Prepare-vote），接受到 2/3 投票的验证者进入 prepared 状态。这里有两点值得关注：

1. 校验 proposal。
2. 广播投票，并且收集到 2/3 投票的验证者进入 prepared 状态。

校验 proposal 目标是确认消息的位置在本地是否可以并且内容无冲突，这样全网的执行顺序可以得到保障。在实现过程中出了保证正常节点顺序一致，对于异常节点（非恶意节点）实现 Gap 数据补偿或者分叉数据回到正确数据链上。

广播投票的目的是让全网知道“我”已经确认了特定位置上的特定消息，如果全网有 2/3 与“我”保持一致，那么就进入prepared 状态，进行下一个阶段。

此时收到了 2/3 与“我”保持一致的确认，为什么不立刻执行还需要下一阶段呢？当前节点“我”收到了 2/3 的确认投票，但是全网其他的节点未必收到 2/3 的确认投票（未执行 proposal），如果“我”此时执行，然后发生切主，在新主的视角下这条消息可能不存在（当然在选取新主的时候可以加上限制--选择最新的 prepare--新主包含最新的 proposal，但是发起切换的验证者可能没有收集到 2/3 的投票，它用这个没有‘敲定’的 proposal 去用于选主吗？这显然是不安全的）。所以，在单一的视角下“我”看到了全网相同位置有相同的消息，并不能确定全网都会正确执行这个消息。

**单一视角下的全网一致，并不是确定性的全网一致**，这也是为什么需要第三个阶段的原因。

Commit 阶段，收集到 2/3 的 Prepare-vote 之后向全网广播，Commit 消息表示我收到了足够的“相同位置相同消息”的确认要开始执行了，如果“我”收到了 2/3 的 Commit-vote, 表示全网收到了同样的足够多的（2/3）“相同位置相同消息”，那么“我”就执行了。

三个阶段的目标很明确：
1. Pre-prepare 阶段：向全网广播“特定视角下（view， leader） + 特定位置（index） + 信息（data）”。
2. Prepare 阶段：收集全网的信息，确认全网在“特定视角下 + 特定位置“ 都得到相同的信息”，全网每个阶段都是独立的，这个收集全网信息的方式都是一样的，被动的等待其他节点的广播投票到来。
3. Commit 阶段：收集全网的信息，确认全网在“特定视角下 + 特定位置 + 特定的信息“都得到了全网的确认，也就是全网视角和“我”的视角是一样的，此时可以执行了。 

协议的核心其实有两个：
1. “我”的视角 与 全网视角，“我”是没有办法控制全网的视角的，所以需要收集两轮投票信息（一个是确认全网消息的位置即执行顺序，一个是确认全网的执行动作统一）。“我”与其他节点是独立的，每个节点的执行都是靠协议推动，出了 leader 提出 proposal 这个动作是需要 leader 这个身份之外，其他的协议状态推动（prepared，commited）都是对等的。
2. 实现“我”的视角 与 全网视角的统一的方式，就是广播，每个节点状态推进是靠被动接受投票推动的。

#### 为什么一定要三阶段，而不是两阶段？

前面已经介绍了，两阶段在切主的时候（由于全网状态不能得到统一），会发生数据不一致的情况。

#### PBFT 和区块链的共识到底有什么关系？对区块链的共识有什么启迪？

PBFT 的历史比区块链共识要早很多，出自 [lamport](https://en.wikipedia.org/wiki/Leslie_Lamport) 经典的分布式论文中。它的意义在于给开放式分布系统（perssionless）的共识提供了基础（有别与 web2 的 Paos，Raft，两阶段等）。后来 ETH 转向 Pos 时，PBFT 的即时敲定特定被 V 神看中，基于 PBFT 的 BFT 类共识结合区块链的特点进行一些列的演进，抱愧 HotSuff 系列等。PBFT 是目前流行的区块链系统的开放式共识的基础，多亿对于他的深入理解和研究是有价值和意义的。

## Reference
[若想搞懂區塊鏈就不能忽視的經典：PBFT](https://medium.com/taipei-ethereum-meetup/intro-to-pbft-31187f255e68)

[实用拜占庭容错算法（PBFT）](https://yangzhe.me/2019/11/25/pbft/#%E4%B8%89%E9%98%B6%E6%AE%B5%E7%9A%84%E4%BD%9C%E7%94%A8)