# PBFT

## 正确性共识定义
1. 安全性：多个节点形成一个唯一的共识
2. 活跃性：一定能产出共识

问题：存在共识算法保证安全性 和 活跃性吗？

根据 FLP 不可能原理，是做不到的，但是要知道这是理论情况。在工程实践中，实际情况（多数情况）是可以做到的。
1. 限定在同步网络（节点时钟误差，网络延时，节点执行耗时都是在确定时间内）——PBFT 的基础。
2. 协议中引入随机性，使得协议更健壮，即使在异步网络中也是可以达成共识的——BTC hash 计算应该算。

结论：在实际情况中打破 FLP 的约束。

## PBFT 投票原理
![pbft](../../images/pbft.png)

### Pre-Prepare
1. leader 接受消息，并打包预备消息（epoch，index，message，sign）发送给其他节点
### Prepare
1. follower 收到消息后会互相通信
2. 任何节点收到 2/3 以上的同意信息（消息带有 sign ）之后，进入 Prepared 状态，并发送执行消息
3. 确认消息的集合称为“**已预备证明**"
### Commit
1. 任何节点收到 2/3 以上的执行消息之后，开始执行.
2. 执行结果返回给 leader 或者 客户端.

上述流程，需要节点间知道全局信息(节点签名等).

## PBFT 换主原理
以上的共识形成的过程非常依赖忠诚的主导者，为了避免不提案的主导者瘫痪所有行动，将军们需要一个轮替机制。
1. 超时机制，超时之后任何节点都可以发起提升为主的请求。
2. 旧主收到新主提升的消息后，会同步未执行的消息给新主。

## 安全性保障
1. 拜占庭问题，2 / 3 以上同意。
2. 三阶段：第二个阶段（Prepare）是确保 2/3 收到相同的消息，否则由于切主导致同一个 epoch 和 index 的命令不同，存在节点执行错误命令。

## 活跃性保障
切主保证了 不会因为停顿的主导者而中断，这个的前提是 网路延迟的增长速度慢于每次超时增加的缓冲时间（即网络延时有限）。

如果在切主的过程中超时，则各将军再发起一次变换，并延长等待时间至2T/3T/4T…以此类推，直到等待时间可以容忍消息的延迟。在最坏的情况下，就算碰到连续 1/3 个叛徒，也能保证其活跃性

## 特性
**PBFT是一个许可制的、基于领袖的、基于通讯的、安全性重于活跃性的共识协定。**

1. 许可制

    节点间需要掌握关键信息（够验证彼此的讯息以及精准掌握节点的数量）。
    
    BlockChain 基于**中本共识(Nakamoto Consensus)**的区块链则是属于对任何人都开放的非许可制(Permissionless)。基于PBFT的权益证明(Proof-of-stake)模型则让参与者可以依据自己的资产进行注册，兼顾对所有人开放的特性又能善用注册掌握验证所需的资讯与节点总数。
2. 基于leader

    这样做最直接的好处就是不需要浪费自己的运算资源去争取当领袖的机会，然而缺点就是只有在视域变换时才轮替领袖，**成为领袖的机会并不公平，缺乏加入网路的诱因**；
    
    区块链则是在多个提案中选择工作证明难度最高的区块作为共识，虽然这样会造成运算资源的浪费，但是成为出块者的机率大致是公平的，其与算力成正比。近来的研究显示：可以透过公平的乱数决定领袖，这样既能保证成为领袖的机会公平，也能节省运算资源。然而怎么保证乱数产生器是公平的？这是下一个大问题。
3. 基于通信

    PBFT的安全性奠基于3阶段投票，虽然不必如工作证明般消耗大量计算资源，但数量庞大的通讯也造成可扩展性的瓶颈— 就算是号称最实用的PBFT，也无法扩展到1000个以上个节点。不仅如此，PBFT使用讯息验证码(MAC)，每投一轮票就需要每一个节点验证一次讯息，大量的签名/验证也是另一个潜在的瓶颈。另一个潜在的问题是，基于通讯的模型是[主观的(Subjective)](https://blog.ethereum.org/2014/11/25/proof-stake-learned-love-weak-subjectivity)，对于远程攻击(Long-range Attack)没有抵抗能力，新参与者无从分辨哪一个才是由诚实节点维护的状态。
    
    相对地，区块链是基于计算的(Computation-based)，它的安全性奠基于可验证的计算证明，虽然在效率上不如基于通讯的作法，然而这样模型却是[客观的(Objective)](https://blog.ethereum.org/2014/11/25/proof-stake-learned-love-weak-subjectivity)，欲加入的新节点只需要根据中本共识(Nakamoto Consensus)选择困难度最高的链加入即可。
4. 安全性优于活跃性 

    PBFT不论在何种网路假设下(同步/非同步)都能确保安全性，几乎不可能出现分岔，因此具有即时敲定(Instant Finality)的特性；
    
    相对地，区块链则是活跃性重于安全性，其安全性有赖于同步的网路，而具有复数个共识(及分岔)的情况也相当常见，需要经过一定数量的区块「确认」才能保证其不再分岔的机率足够大。

## 参考
https://medium.com/taipei-ethereum-meetup/intro-to-pbft-31187f255e68