# Consensus

本篇文章目的有两个：第一，理清区块链共识协议的前世今生，只有知道为什么区块链需要共识协议才能掌握共识协议的本质；
第二，掌握典型的共识协议核心，在此基础上才能做到快速学习和对比市面上各种共识协议。可以做到类比学习其他共识协议，是本篇文章的终极目标。

## Background

### Core question: PoW change to PoS

PoS 的提出解决了 PoW 效率，硬件带来的资源消耗问题，成为它替代 PoW 的最强驱动力。
然而，PoS 并不是提出来之后就可以直接替换 PoW。PoS 替换 PoW 最核心的 问题就是，
PoS 作恶的成本比 PoW 低了很多，即安全性无法与 PoW 保持一致。

### Long Range Attack

PoW 中判断主链的方法是最长链，因为最长链能够代表最多的工作量。但是 PoS 中最长链
不能够代表主链，因为 PoS 伪造一个最长链是很容易的，因为没有任何额外的工作量（这是与 PoW 本质的区别）。

伪造最长链的攻击成为远程攻击，远程攻击的本质是从创世纪块开始伪造主链（后面会介绍为什么不关注短程攻击）。
下面开看一下典型的远程攻击方式，从而理解 PoS 可能很容实现或者说无成本实现远程攻击。

在正式介绍远程攻击之前，有必要描述清楚攻击针对的场景，远程攻击中主要是针对新节点
或者下线很久的节点再上线之后，使其无法识别主链，即观察到的最长链是攻击链，从而完
成远程攻击。

第一种远程攻击，作恶节点在维护主链的同时，快速基于创世纪块出块，让其他验证者的位置
出空块，只要伪造其时间戳就可以，这样自己伪造的链随着时间一定是最长链。

第二种远程攻击，当验证者在主链上推出之后，不再是链的利益相关者，作恶者可以贿赂或者
盗取其私钥，从而基于创世纪块完成快速出块，此时除了作恶者本身还有其他节点出非空块，
这种攻击避免了伪造时间戳，也称作变节攻击。

第三种远程攻击，作恶者仍然在主链上工作，但是在自己出块的时候拖延不出块，尽量拉长出块
时间，这样给其作恶争取时间，也会造成作恶链成为最长链。这种攻击会导致主链上作恶节点质
押的损失，也称作质押流失攻击。

通过介绍上述典型的基于 PoS 的远程攻击，可以看出来本质上就是 PoS 出块不需要额外的计
算成本，导致作恶成本极低。

同时还有一种情况会更糟，就是验证者可能会对多个分叉进行投票，这是无风险的且收益最高的，
但是针对 PoW 这种方式不行的，因为在 PoW 中出新块必须绑定到一个分叉上，否则算力就被
拆分了，PoS 没有算力拆分也就没有什么成本（这里还没有设计完整的 PoS 协议，比如惩罚双重投票）。

*注意：对于 PoW 完成远程攻击不是不可能的，需要完成 51% 攻击。所以我们要解决上述
PoS 的远程攻击问题的本质，并不是要彻底解决，而至在不考虑 51% 攻击的情况下解决，
即 PoS 中如果有 51% 质押的验证者被控制了，那么是可以进行远程攻击的，这个是解决问
题的边界。*

最后，需要描述一下为什么只考虑远程攻击，而不考虑短程攻击，因为只关注短程分叉，
总是可以通过协议判断出哪个是主链，从而通过惩罚保证金保证验证节点不作恶（后面会详细介绍 Slashing）。

### Weak Subjectivity

为了解决 PoS 的远程攻击问题，V 神提出了 [Weak Subjectivity](https://blog.ethereum.org/2014/11/25/proof-stake-learned-love-weak-subjectivity)。
要想理解弱主观性，需要先明确什么是客观性，什么是主观性。

客观性指的是一个新节点加入网络时，仅仅知道如下两部分信息，就可以独立的得出与网络其他部分相同的当前状态。
1. 协议。
2. 所有已经发布的区块，及其他”必要“的信息。

主观性指的是，系统存在稳定状态，但是不同节点需要大量的社会信息才能确定，否则会得出不同的结论。

客观性的规则（协议）通过开源代码确认，发布的数据在网络中客观存在且自由流动，所以共识过程没有人为参与。
主观性则需要大量人为参与（社会信息，比如信誉等）。可以看出来两者完全是两个极端，一个完全没有人为参与，
一个是没有人为参与就无法达成共识。弱主观性其实就是介于两者之前，在客观性的基础上添加必要的少量的人为
参与部分。没有人为参与的部分是无法避免远程攻击的所以是主观的，大部分依靠客观性的两个条件推进所以是弱主观的。

下面来看一下弱主观的内容：
1. 协议。
2. 所有已经发布的区块，及其他”必要“的信息。
3. 一个少于N个区块之前的已知有效状态。

其中一个确定的（finality）有效状态（距离最新块少于 N 个 Block）是弱主观性添加的，核心就是这个有效
状态之前的状态不可以在更改了，已经达成共识了，成本 chain 必要信息的一部分了。

*注意：弱主观性新加的条件也不是一定的（距离最新块之前 N 个 Block 的状态不会变更），因为还有可能是
51%攻击，弱主观性解决了远程攻击，但是没有解决 51% 攻击，这和 PoW 的安全级别是一样的。*

接下来具体看一下 PoS 基于弱主观性是如何工作的，首先新介入的节点可以人为（通过其他节点的网站）
获取最新的有效状态，设置一个 epoch 大于N，如果一个 validator 退出，必须在 2个 epoch 之后
才能提款，保证没有作恶（这也是 PoS 不用考虑短程攻击的原因，只关注短程总是有办法在主链上判断出作恶）。

最后，社区中各种 PBFT 共识天然带有即时敲定的特性，与 PoS 结合之后都会实现弱主观性。
唯独以太坊的 Casper FFG 比较特殊，它看中了 PBFT 的即时敲定特性，结合最小惩罚条件，
以及最长连的规则（LWD-GHOST）结合 PoS 实现了一个覆盖层，完成了以太坊 PoW 到 PoS
的切换。

## Consensus Protocol

在介绍共识算法之前，我们需要明白如何评价一个共识算法是否可行或者说是正确。
即什么标准判断一个共识算法是否是正确，不满足这些标准就是有漏洞的共识算法。

同时我们还要明白两个问题：第一，正确的共识算法的边界是什么？共识算法不是万能的，
一定有它的边界或者说取舍（不可兼得），需要我们清楚。第二，一个正确的共识算法可能
需要满足一些列约束，共识算法在不同的应用场景中在满足约束的前提下可能有侧重（优先满足，失败就回滚等等），
这也是我们评判一个共识算法的标准。

首先，一个正确的共识的算法应该满足一下两点：
1. 安全性：一定会达成唯一的共识（全局达成一致，不能分歧）；
2. 活性：共识一定会形成（不能停）；

[FLP](./flp.md) 原理阐述了在异步环境下，安全性和活性不能同时满足。
在接下来介绍的 PBFT, Tendermint PBFT 和 Casper 都是在同步环境下，
即节点通信在有限时间内完成，如果超时协议有机制保证继续。

有的协议倾向安全性，不保证全局达成一致就会一直等。
有的协议倾向活性优先，先继续，遇到分叉有其他机制保证。

### PBFT

[PBFT](./pbft.md) 主要有两部分，第一是理解三阶段的作用，其中的第二阶段是对即将执行的消息达成共识，防止切主的时候丢数据；
第二是切主部分，这块主要类似 [raft](../../../distributed_protocol/raft)，[paxos](../../../distributed_protocol/paxos) 理解即可。

PBFT 是一个非常典型的共识协议，PoS 中有大量的应用，但是我们也要知道 PBFT 本身并不是
给区块链设计的，有很多不适合的地方，结合上了 PoS 才在区块链中有大量的使用，掌握 PBFT
的特点才会知道那些不适合区块链，才会明白怎么与 PoS 结合。

* 许可制
   
   PBFT 并不是开发共识协议，简单说她需要一个验证者集合，加入需要许可，并不想 PoW 那样
   任何节点，无需许可即可加入。PoS 的质押正好可以规定参与的集合。 

* 基于 leader 

   [PBFT](./pbft.md) 中介绍过切主只能防止主不发送消息，并不能保证主作恶，所以对于 leader 
   是有安全依赖的。区块链中其他节点会验证 leader 的执行结果，作恶会有惩罚，并且 PoS 的轮换
   机制保证了 leader 的轮替。

* 基于通信

   三阶段是需要大量的通信完成共识，限制了验证集合的规模，通信规模与验证集规模成指数变化。
   PoW 不是基于通信的，PoS 通过抬高质押门槛限制规模。

* 安全性优先于活性

   PBFT 来自传统的分布式系统（即非开放控制），协议是不会出现分叉的，最多就是等超时切主。
   区块链中分岔是可接受的，通过最长连原则选出主链，但是准时出块是重要的。

### Tendermint PBFT

[Tendermint PBFT](./tendermint_bft.md) 与 PBFT 相比，针对 PoS 进行
优化更适合区块链，它的锁定机制避免了 PBFT 在切主的时候发送很多证明集合。并且
针对 PoS 的设计他的安全性和活性也更好。

锁定机制记录了“要执行的消息，但未执行，且 2/3
达成了共识”，当切换新主的时候，这个记录可以直接用而忽略新主的新提案，不
论切换谁（即使新的主没有锁定这个消息），这个消息都会被 commit。PBFT
没有锁定机制，所以在切换主的时候需要同步 checkpoint 及其证明集合，Prepared
证明集合等大量消息。所以Tendermint PBFT 与 PBFT 最主观的区别就是提升了
切主的效率。PoS 中主的切换是轮训，并不是 PBFT 超时视域变换（选出最 Prepared 消息最多的新主），
新主很可能就没有前一轮 Prepared 的消息，Tendermint PBFT 应该说更适合 PoS。

Tendermint BFT 的活性更好一点，在安全性得不到保证的时候选择出空块，
PBFT 就会卡住等待超时的视域变换。

Tendermint BFT 的安全新更好一点，2/3 以上作恶节点才能控制 Tendermint BFT，
1/3 到 2/3 作恶节点就已经可以是 PBFT 不出块了。

### Casper FFG

[Casper FFG](./casper_ffg.md) 重点使用了 PBFT 的天生属性——即时敲定。
将 PBFT 的 Prepare，Commit 等三阶段的状态，用检查点的 Justified 和 Finalized 以 Pipeline 的方式实现。
Casper FFG 的最小削减条件，体现了设计的精髓，用简洁的方式对复杂的约束条件进行了描述，保证了检查点的正确推进（安全和活性）。

## Reference
1. [Proof of Stake: How I Learned to Love Weak Subjectivity](https://blog.ethereum.org/2014/11/25/proof-stake-learned-love-weak-subjectivity)
2. [Minimal Slashing Conditions](https://medium.com/@VitalikButerin/minimal-slashing-conditions-20f0b500fc6c)
3. [若想搞懂區塊鏈就不能忽視的經典：PBFT](https://medium.com/taipei-ethereum-meetup/intro-to-pbft-31187f255e68)
4. [Casper FFG：以實現權益證明為目標的共識協定](https://medium.com/taipei-ethereum-meetup/intro-to-casper-ffg-and-eth-2-0-95705e9304d6)
5. [Pos的远程攻击](https://www.elecfans.com/blockchain/930761.html)
6. [共识算法的比较-Casper vs Tendermint](https://blog.csdn.net/weixin_34112030/article/details/92410242)
